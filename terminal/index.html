<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AniPub • Arch Terminal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background:#000;
    color:#fff;
    font-family:'JetBrains Mono', 'Courier New', monospace;
    height:100vh;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    font-size:15px;
    line-height:1.6;
  }
  #term {
    flex:1;
    padding:30px 40px 20px;  /* Proper top padding for logo */
    overflow-y:auto;
    background:#000;
  }
  #term::-webkit-scrollbar { width:6px; background:#000; }
  #term::-webkit-scrollbar-thumb { background:#333; border-radius:3px; }

  .title-bar {
    position:fixed;
    top:0; left:0; right:0;
    height:36px;
    background:#111;
    color:#888;
    font-size:13px;
    line-height:36px;
    padding:0 15px;
    border-bottom:1px solid #222;
    user-select:none;
    z-index:10;
  }
  .dots { float:left; margin-right:15px; }
  .dot { display:inline-block; width:12px; height:12px; border-radius:50%; margin:12px 4px 0 0; }
  .red { background:#ff5f57; }
  .yellow { background:#febc2e; }
  .green { background:#28c840; }

  .logo {
    text-align:center;
    margin:10px 0 30px 0;
    color:#0f0;
    font-size:13px;
    line-height:1.4;
    letter-spacing:1px;
  }
  .logo .title {
    font-size:16px;
    color:#87ff87;
    font-weight:bold;
    margin-top:8px;
  }

  .line { margin:5px 0; word-wrap:break-word; }
  .prompt { color:#0f0; font-weight:bold; }
  .input-line { display:flex; align-items:center; margin:5px 0; }
  .input {
    background:none;
    border:none;
    outline:none;
    color:#fff;
    font-family:inherit;
    font-size:15px;
    flex:1;
    margin-left:6px;
    caret-color:#0f0;
  }

  .card {
    background:#0a0a0a;
    border:1px solid #222;
    border-radius:8px;
    padding:18px;
    margin:20px 0;
  }
  .anime-title {
    font-size:21px;
    color:#87ff87;
    font-weight:bold;
    margin-bottom:14px;
  }
  .info-grid {
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
    gap:12px;
    margin:16px 0;
  }
  .info-item {
    background:#111;
    padding:11px 14px;
    border-radius:6px;
    border-left:3px solid #0f0;
  }
  .label { font-size:11px; color:#666; text-transform:uppercase; letter-spacing:0.8px; }
  .value { margin-top:5px; color:#fff; font-weight:600; font-size:14.5px; }
  .desc {
    background:#080808;
    padding:15px;
    border-radius:6px;
    margin:18px 0;
    color:#bbb;
    line-height:1.8;
    font-size:14px;
  }
  .btn {
    display:inline-block;
    padding:10px 18px;
    margin:6px 10px 6px 0;
    background:#000;
    border:1px solid #0f0;
    color:#0f0;
    border-radius:6px;
    cursor:pointer;
    font-size:14px;
    font-weight:bold;
    text-decoration:none;
  }
  .btn:hover { background:#0f0; color:#000; }
  .btn.watch { border-color:#87ff87; color:#87ff87; }
  .btn.watch:hover { background:#87ff87; color:#000; }

  .cover-img {
    max-width:100%;
    border:2px solid #0f0;
    border-radius:8px;
    margin:22px 0;
    display:block;
  }
  .dim { color:#666; }
  .red { color:#ff5555; }
</style>
</head>
<body>

<div class="title-bar">
  <div class="dots">
    <span class="dot red"></span>
    <span class="dot yellow"></span>
    <span class="dot green"></span>
  </div>
  anipub-terminal — /home/user
</div>

<div id="term">
  <div class="logo">
    █████╗  ███╗   ██╗██╗██████╗ ██╗   ██╗██████╗ <br>
    ██╔══██╗████╗  ██║██║██╔══██╗██║   ██║██╔══██╗<br>
    ███████║██╔██╗ ██║██║██████╔╝██║   ██║██████╔╝<br>
    ██╔══██║██║╚██╗██║██║██╔═══╝ ██║   ██║██╔══██╗<br>
    ██║  ██║██║ ╚████║██║██║     ╚██████╔╝██║████║<br>
    ╚═╝  ╚═╝╚═╝  ╚═══╝╚═╝╚═╝      ╚═════╝ ╚═╝  ╚═╝<br><br>
    <div class="title">A N I P U B • TERMINAL</div>
  </div>
  <div class="line dim">Connecting to AniPub database...</div>
</div>

<script>
const term = document.getElementById('term');
let mode = 'main';
let TOTAL = 0;
const PROXY = 'https://api.allorigins.win/raw?url=';

function println(text = '') {
  const line = document.createElement('div');
  line.className = 'line';
  line.innerHTML = text;
  term.appendChild(line);
  term.scrollTop = term.scrollHeight;
}

function clear() {
  term.innerHTML = `
    <div class="logo">
      █████╗  ███╗   ██╗██╗██████╗ ██╗   ██╗██████╗ <br>
      ██╔══██╗████╗  ██║██║██╔══██╗██║   ██║██╔══██╗<br>
      ███████║██╔██╗ ██║██║██████╔╝██║   ██║██████╔╝<br>
      ██╔══██║██║╚██╗██║██║██╔═══╝ ██║   ██║██╔══██╗<br>
      ██║  ██║██║ ╚████║██║██║     ╚██████╔╝██║████║<br>
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚═╝╚═╝      ╚═════╝ ╚═╝  ╚═╝<br><br>
      <div class="title">A N I P U B • TERMINAL</div>
    </div>
    <div class="line dim">Database: ${TOTAL} anime entries loaded</div>
    <div class="line">Type an ID (1–${TOTAL}), <b>w</b> for watch mode, or <b>help</b></div>
  `;
}

function createInput() {
  const line = document.createElement('div');
  line.className = 'input-line';
  line.innerHTML = `<span class="prompt">${mode === 'watch' ? 'watch' : 'user'}@anipub ~ $</span><input class="input" autofocus>`;
  term.appendChild(line);
  const input = line.querySelector('input');
  input.focus();

  input.addEventListener('keydown', async e => {
    if (e.key !== 'Enter') return;
    const cmd = input.value.trim();
    input.disabled = true;
    if (cmd) {
      println(`<span class="prompt">${mode === 'watch' ? 'watch' : 'user'}@anipub ~ $</span> ${cmd}`);
    }
    await run(cmd);
    createInput();
  });

  term.onclick = () => input.focus();
}

async function getJSON(url) {
  try {
    const r = await fetch(PROXY + encodeURIComponent(url));
    if (!r.ok) return null;
    const text = await r.text();
    return text.trim() === '' ? null : JSON.parse(text);
  } catch { return null; }
}

function fixImage(path) {
  if (!path) return null;
  return path.startsWith('http') ? path : `https://www.anipub.xyz/${path}`;
}

function showCover(url) {
  println(`<img src="${url}" class="cover-img" alt="Anime Cover">`);
}

async function run(cmd) {
  const low = cmd.toLowerCase();

  if (low === 'clear') { clear(); return; }
  if (low === 'help') {
    println(`
      <div class="card">
        <div class="anime-title">Commands</div>
        <b>ID</b> → Show anime info<br>
        <b>w</b> → Enter watch mode<br>
        <b>back</b> → Exit watch mode<br>
        <b>help</b> → This help<br>
        <b>clear</b> → Clear screen<br>
        <b>q</b> → Quit
      </div>
    `);
    return;
  }
  if (low === 'w') {
    mode = 'watch';
    println('<span style="color:#0f0">Watch mode activated — type any ID to play</span>');
    return;
  }
  if (mode === 'watch' && low === 'back') {
    mode = 'main';
    println('Back to main mode');
    return;
  }
  if (low === 'q') {
    println('<span class="red">Terminal closed.</span>');
    return;
  }

  if (/^\d+$/.test(cmd)) {
    const id = parseInt(cmd);
    if (id < 1 || id > TOTAL) {
      println(`<span class="red">Invalid ID! Use 1–${TOTAL}</span>`);
      return;
    }
    if (mode === 'watch') {
      window.open(`https://anipub.xyz/aniplayer/${id}/0`, '_blank');
      println(`Opening player for ID ${id}...`);
      return;
    }

    println(`<span style="color:#0f0">Loading anime ID ${id}...</span>`);
    const anime = await getJSON(`https://www.anipub.xyz/api/info/${id}`);
    if (!anime?.Name) {
      println('<span class="red">Anime not found</span>');
      return;
    }

    const img = fixImage(anime.ImagePath);
    const ep = (anime.epCount || 0) + 1;
    const genres = Array.isArray(anime.Genres) ? anime.Genres.join(', ') : anime.Genres || '—';

    println(`
      <div class="card">
        <div class="anime-title">${anime.Name}</div>
        <div class="info-grid">
          <div class="info-item"><div class="label">Episodes</div><div class="value">${ep}</div></div>
          <div class="info-item"><div class="label">Status</div><div class="value">${anime.Status || '—'}</div></div>
          <div class="info-item"><div class="label">Aired</div><div class="value">${anime.Aired || '—'}</div></div>
          <div class="info-item"><div class="label">Score</div><div class="value">${anime.MALScore || '—'}</div></div>
          <div class="info-item"><div class="label">Studio</div><div class="value">${anime.Studios || '—'}</div></div>
          <div class="info-item"><div class="label">Genres</div><div class="value">${genres}</div></div>
        </div>
        <div class="desc">${(anime.DescripTion || 'No description.').replace(/\n/g, '<br>')}</div>
        <div>
          ${img ? `<button class="btn" onclick="showCover('${img}')">View Cover</button>` : ''}
          <a href="https://anipub.xyz/aniplayer/${anime._id}/0" target="_blank" class="btn watch">Watch Now</a>
        </div>
      </div>
    `);
    return;
  }

  println('<span class="red">Command not found — type help</span>');
}

window.showCover = showCover;

// Start
(async () => {
  const totalData = await getJSON('https://www.anipub.xyz/api/getAll');
  TOTAL = parseInt(totalData) || 80;

  term.innerHTML = '';
  term.innerHTML = `
    <div class="logo">
      █████╗  ███╗   ██╗██╗██████╗ ██╗   ██╗██████╗ <br>
      ██╔══██╗████╗  ██║██║██╔══██╗██║   ██║██╔══██╗<br>
      ███████║██╔██╗ ██║██║██████╔╝██║   ██║██████╔╝<br>
      ██╔══██║██║╚██╗██║██║██╔═══╝ ██║   ██║██╔══██╗<br>
      ██║  ██║██║ ╚████║██║██║     ╚██████╔╝██║████║<br>
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚═╝╚═╝      ╚═════╝ ╚═╝  ╚═╝<br><br>
      <div class="title">A N I P U B • TERMINAL</div>
    </div>
    <div class="line dim">Database: ${TOTAL} anime entries loaded</div>
    <div class="line">Type an ID (1–${TOTAL}), <b>w</b> for watch mode, or <b>help</b></div>
  `;
  createInput();
})();
</script>
</body>
</html>
